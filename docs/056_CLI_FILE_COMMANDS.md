# CLI File Commands

**Date**: 2025-11-17  
**Status**: âœ… Implemented  
**Related**: File Retrieval API, CLI

## Overview

Added three new CLI commands to the master node for viewing and downloading files generated by tasks. These commands provide a user-friendly interface to the file storage system with built-in access control.

---

## Commands

### 1. `files` - List All Files for a User

**Usage**: `files <user_id> [requesting_user]`

**Description**: Lists all task files for a specific user with access control.

**Parameters**:
- `user_id` (required): User whose files to list
- `requesting_user` (optional): User making the request (defaults to same as user_id)

**Examples**:
```bash
# List your own files
master> files alice

# Admin listing another user's files
master> files alice admin
```

**Output**:
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘  Files for User: alice
â•‘  Total Tasks: 2
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘  [1] Task: data-processing
â•‘      Task ID:   task-123
â•‘      Timestamp: 2025-11-17 14:30:00
â•‘      Files:     2
â•‘        - output.txt
â•‘        - results.csv
â•‘      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â•‘  [2] Task: model-training
â•‘      Task ID:   task-456
â•‘      Timestamp: 2025-11-17 15:45:00
â•‘      Files:     1
â•‘        - model.pkl
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’¡ Tips:
   - View task files: task-files <task_id> alice
   - Download file: download <task_id> <file_path> alice
```

---

### 2. `task-files` - View Files for a Specific Task

**Usage**: `task-files <task_id> <user_id> [requesting_user]`

**Description**: Shows detailed file information for a specific task.

**Parameters**:
- `task_id` (required): Task ID to view files for
- `user_id` (required): User who owns the task
- `requesting_user` (optional): User making the request (defaults to same as user_id)

**Examples**:
```bash
# View your own task files
master> task-files task-123 alice

# Admin viewing another user's task files
master> task-files task-123 alice admin
```

**Output**:
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘  Task Files: task-123
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘  Task Name:  data-processing
â•‘  Owner:      alice
â•‘  Timestamp:  2025-11-17 14:30:00
â•‘  Storage:    /home/user/.cloudai/files/alice/data-processing/2025-11-17_14-30-00/task-123
â•‘  Files:      2
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘  [1] output.txt
â•‘  [2] results.csv
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’¡ To download a file:
   download task-123 <file_path> alice
   Example: download task-123 output.txt alice
```

---

### 3. `download` - Download a File

**Usage**: `download <task_id> <file_path> <user_id> [requesting_user] [output_path]`

**Description**: Downloads a specific file from a task's output directory.

**Parameters**:
- `task_id` (required): Task ID
- `file_path` (required): Relative path to file in task directory
- `user_id` (required): User who owns the task
- `requesting_user` (optional): User making the request (defaults to same as user_id)
- `output_path` (optional): Local path to save file (defaults to current directory with same filename)

**Examples**:
```bash
# Download to current directory
master> download task-123 output.txt alice

# Download with custom output path
master> download task-123 output.txt alice alice /tmp/my-output.txt

# Admin downloading another user's file
master> download task-123 results.csv alice admin ./alice-results.csv

# Download file from subdirectory
master> download task-456 logs/app.log bob
```

**Output**:
```
Downloading file 'output.txt' from task 'task-123'...
âœ“ File downloaded successfully!
  Source: output.txt (task: task-123)
  Destination: output.txt
  Size: 1024 bytes
```

---

## Access Control

All commands enforce CloudAI's access control policies:

### Scenario 1: User Accessing Own Files âœ…
```bash
master> files alice
# Alice listed as both user_id and requesting_user â†’ Allowed
```

### Scenario 2: User Accessing Another User's Files âŒ
```bash
master> files bob alice
# Alice tries to list Bob's files â†’ Denied (403 Forbidden)
```

### Scenario 3: Admin Accessing Any Files âœ…
```bash
master> files bob admin
# Admin can access any user's files â†’ Allowed
```

---

## Complete Workflow Example

### Step 1: Submit Task
```bash
master> task alpine alice 1 512 0 echo Hello > /output/greeting.txt
âœ“ Task submitted: task-abc123
```

### Step 2: Wait for Completion
```bash
master> list-tasks running
# Wait until task shows as completed
```

### Step 3: List Files
```bash
master> files alice
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘  Files for User: alice
â•‘  Total Tasks: 1
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘  [1] Task: alpine
â•‘      Task ID:   task-abc123
â•‘      Timestamp: 2025-11-17 16:00:00
â•‘      Files:     1
â•‘        - greeting.txt
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Step 4: View Task Files
```bash
master> task-files task-abc123 alice
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘  Task Files: task-abc123
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘  Task Name:  alpine
â•‘  Owner:      alice
â•‘  Files:      1
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘  [1] greeting.txt
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Step 5: Download File
```bash
master> download task-abc123 greeting.txt alice
Downloading file 'greeting.txt' from task 'task-abc123'...
âœ“ File downloaded successfully!
  Source: greeting.txt (task: task-abc123)
  Destination: greeting.txt
  Size: 6 bytes
```

### Step 6: Verify Content
```bash
# Exit CLI and check file in terminal
$ cat greeting.txt
Hello
```

---

## Error Handling

### File Storage Not Available
```bash
master> files alice
âŒ File storage not available
```

### Access Denied
```bash
master> files bob alice
âŒ Failed to list files: access denied: user alice cannot access files owned by bob
```

### Task Not Found
```bash
master> task-files task-999 alice
âŒ Failed to get task files: task files not found for task task-999
```

### File Not Found
```bash
master> download task-123 nonexistent.txt alice
âŒ Failed to read file: file not found: nonexistent.txt
```

### Path Traversal Blocked
```bash
master> download task-123 ../../../etc/passwd alice
âŒ Failed to read file: access denied: path traversal not allowed
```

---

## Implementation Details

### CLI Structure Update
```go
type CLI struct {
    masterServer *server.MasterServer
    fileStorage  *storage.FileStorageService  // NEW: Added file storage
    rl           *readline.Instance
}

func NewCLI(srv *server.MasterServer, fs *storage.FileStorageService) *CLI {
    return &CLI{
        masterServer: srv,
        fileStorage:  fs,  // NEW: Accept file storage
        rl:           rl,
    }
}
```

### Commands Added
- `listFiles(requestingUser, targetUser string)` - Lists all files for a user
- `showTaskFiles(taskID, requestingUser, targetUser string)` - Shows task file details
- `downloadFile(taskID, filePath, requestingUser, targetUser, outputPath string)` - Downloads a file

### Access Control Integration
All commands use `*WithAccess()` methods:
```go
// List files
fileList, err := c.fileStorage.ListUserFilesWithAccess(requestingUser, targetUser)

// Get task files
metadata, err := c.fileStorage.GetTaskFilesWithAccess(requestingUser, targetUser, taskID)

// Read file
fileData, err := c.fileStorage.ReadFileWithAccess(requestingUser, targetUser, taskID, filePath)
```

---

## Comparison: CLI vs HTTP API

### CLI Commands
**Pros**:
- âœ… User-friendly interactive interface
- âœ… No need for curl/HTTP knowledge
- âœ… Formatted, colored output
- âœ… Built-in help and examples
- âœ… Direct file download to local system

**Use Cases**:
- Interactive debugging
- Manual file inspection
- Quick file downloads
- Development/testing

### HTTP API
**Pros**:
- âœ… Programmatic access
- âœ… Integration with scripts/tools
- âœ… Remote access from any system
- âœ… JSON responses for parsing

**Use Cases**:
- Automation scripts
- Web interfaces
- CI/CD pipelines
- External integrations

---

## Tips and Best Practices

### 1. Default Requesting User
When `requesting_user` is omitted, it defaults to `user_id`:
```bash
# These are equivalent:
master> files alice
master> files alice alice
```

### 2. Admin Usage
Admins should explicitly specify `requesting_user=admin`:
```bash
master> files alice admin
master> task-files task-123 alice admin
master> download task-123 output.txt alice admin
```

### 3. Output Path
Specify output path to avoid overwriting files:
```bash
# Bad: May overwrite existing output.txt
master> download task-123 output.txt alice

# Good: Explicit unique path
master> download task-123 output.txt alice alice ./task-123-output.txt
```

### 4. Listing Before Download
Always list files first to see what's available:
```bash
master> files alice              # See all tasks
master> task-files task-123 alice # See specific files
master> download task-123 output.txt alice  # Download specific file
```

---

## Related Documentation

- [File Retrieval API](./053_FILE_RETRIEVAL_API.md) - HTTP API reference
- [File API Quick Reference](./054_FILE_API_QUICK_REF.md) - Quick lookup guide
- [Access Control Implementation](./051_ACCESS_CONTROL_IMPLEMENTATION.md) - Security details

---

## Summary

âœ… **Three New CLI Commands**:
- `files` - List user files
- `task-files` - View task file details
- `download` - Download files

âœ… **Features**:
- Access control enforcement
- Formatted, user-friendly output
- Built-in help and examples
- Error handling with clear messages

âœ… **Integration**:
- Uses FileStorageService with access control
- Consistent with HTTP API behavior
- Supports admin privileges

The CLI now provides a complete interface for file management alongside the HTTP API! ğŸš€
