# File Transfer & Storage - Quick Reference

## ğŸš€ Quick Start

### Build System
```bash
cd /home/codesmith28/Projects/CloudAI
make proto    # Generate gRPC code
make master   # Build master
make worker   # Build worker
```

### Start Services
```bash
# Terminal 1: MongoDB
cd database && docker-compose up -d

# Terminal 2: Master
cd master && ./masterNode

# Terminal 3: Worker
cd worker && ./workerNode
```

---

## ğŸ“ File Organization

### Worker (Local Storage)
```
/var/cloudai/outputs/<task-id>/
â””â”€â”€ [files generated by container]
```

### Master (Organized Storage)
```
/var/cloudai/files/<user-id>/<task-name>/<timestamp>/<task-id>/
â””â”€â”€ [files uploaded from worker]
```

---

## ğŸ”„ Data Flow

```
Container writes â†’ /output (inside container)
                â†“
Volume mount   â†’ /var/cloudai/outputs/<task-id>/ (worker host)
                â†“
Worker collects â†’ Lists all files in directory
                â†“
Worker uploads â†’ Streams via gRPC to master
                â†“
Master stores  â†’ /var/cloudai/files/<user>/<task>/<time>/<id>/
                â†“
Master DB      â†’ FILE_METADATA collection
```

---

## ğŸ› ï¸ Developer Guide

### Writing Tasks That Generate Files

```python
# In your containerized task (e.g., task.py)
import json

# Write to /output directory
result = {"status": "success", "accuracy": 0.95}
with open("/output/result.json", "w") as f:
    json.dump(result, f)

# Create subdirectories
import os
os.makedirs("/output/models", exist_ok=True)
with open("/output/models/weights.pkl", "wb") as f:
    # Save model weights
    pass
```

### Building Sample Tasks

```dockerfile
# Dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY task.py .

# Note: /output directory will be mounted by CloudAI
CMD ["python", "-u", "task.py"]
```

---

## ğŸ” Debugging

### Check Worker Logs
```bash
# Worker creates directory
[Task task-123] Created output directory: /var/cloudai/outputs/task-123

# Worker collects files
[Task task-123] âœ“ Collected 3 output file(s)

# Worker uploads
[Task task-123] Uploading 3 output file(s) to master...
[Task task-123] âœ“ Uploaded file: result.json (1024 bytes)
[Task task-123] âœ“ Output files uploaded successfully
```

### Check Master Logs
```bash
# Master receives upload
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ğŸ“¤ FILE UPLOAD REQUEST
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[FileStorage] Receiving files for task task-123 (user: admin, task_name: ml-job)
[FileStorage] Receiving file: result.json
[FileStorage] âœ“ File complete: result.json
[FileStorage] âœ“ All files received (3 files) for task task-123
âœ“ File metadata stored in database
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  âœ“ FILE UPLOAD COMPLETE
  Task: task-123 | User: admin | Files: 3
  Storage Path: /var/cloudai/files/admin/ml-job/2025-11-17_10-30-00/task-123
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### Verify File Storage
```bash
# On worker
ls -la /var/cloudai/outputs/task-123/

# On master
ls -la /var/cloudai/files/admin/ml-job/

# In MongoDB
mongo cluster_db
> db.FILE_METADATA.find({user_id: "admin"}).pretty()
```

---

## ğŸ“Š Database Schema

### FILE_METADATA Collection
```javascript
{
  "user_id": "admin",
  "task_id": "task-1731677400",
  "task_name": "ml-training",
  "timestamp": ISODate("2025-11-17T10:30:00Z"),
  "file_paths": ["result.json", "model.pkl"],
  "storage_path": "/var/cloudai/files/admin/ml-training/2025-11-17_10-30-00/task-1731677400",
  "uploaded_at": ISODate("2025-11-17T10:35:00Z")
}
```

---

## ğŸ”§ Configuration

### Worker Output Directory
Default: `/var/cloudai/outputs/`

To change, modify in `worker/internal/executor/executor.go`:
```go
outputDir := fmt.Sprintf("/custom/path/outputs/%s", taskID)
```

### Master Storage Directory
Default: `/var/cloudai/files/`

To change, modify in `master/main.go`:
```go
fileStorage, err = storage.NewFileStorageService("/custom/path/files")
```

### File Chunk Size
Default: 1MB

To change, modify in `worker/internal/server/worker_server.go`:
```go
const chunkSize = 2 * 1024 * 1024 // 2MB
```

---

## âš ï¸ Troubleshooting

### Files Not Appearing

**Problem**: Container exits but no files uploaded

**Check**:
1. Did container write to `/output`?
   ```bash
   # In container: ls -la /output
   ```
2. Is volume mounted?
   ```bash
   # Check worker logs for: "Created output directory"
   ```
3. Are files collected?
   ```bash
   # Check worker logs for: "Collected X output file(s)"
   ```

**Solution**: Ensure your task writes to `/output` directory

### Permission Denied

**Problem**: Cannot create output directory

**Solution**:
```bash
sudo mkdir -p /var/cloudai/outputs
sudo chmod 755 /var/cloudai/outputs
```

### Upload Fails

**Problem**: "Failed to upload output files"

**Check**:
1. Master address configured?
2. Master running?
3. Network connectivity?

**Solution**:
```bash
# Test connection
telnet <master-ip> 50051
```

---

## ğŸ¯ API Endpoints (Coming Soon)

### List User Files
```bash
GET /api/files?user_id=admin
```

### Get Task Files
```bash
GET /api/files/:task_id
```

### Download File
```bash
GET /api/files/:task_id/:file_path
```

### Delete Task Files
```bash
DELETE /api/files/:task_id
```

---

## ğŸ“ˆ Performance Tips

1. **Large Files**: System uses streaming (1MB chunks)
2. **Many Files**: Uploaded sequentially (could parallelize)
3. **Storage**: Files stored on local disk (consider network storage)
4. **Cleanup**: Implement retention policy to manage disk space

---

## ğŸ” Security Notes

- Files organized by user_id (prevents cross-user access)
- Database queries filtered by user_id
- HTTP API will require authentication (to be implemented)
- Consider encryption for sensitive data

---

## ğŸ“š Related Documentation

- [Full Implementation Summary](./043_FILE_TRANSFER_AND_STORAGE.md)
- [Proto Definitions](../proto/master_worker.proto)
- [Architecture](./038_architecture.md)
- [Database Schema](./039_schema.md)

---

## âœ… Checklist for New Tasks

- [ ] Task writes output to `/output` directory
- [ ] Files created with correct permissions
- [ ] Directory structure (if needed) created
- [ ] Task exits with code 0 on success
- [ ] Tested locally before submitting

---

**Last Updated**: November 17, 2025  
**Status**: Core implementation complete
