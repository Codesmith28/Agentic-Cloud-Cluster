# File Retrieval API Documentation

**Date**: 2025-11-17  
**Status**: ✅ Implemented and Tested  
**Related**: File Transfer, Access Control, HTTP API

## Overview

The File Retrieval API provides HTTP REST endpoints for users to list, view, download, and delete files generated by their tasks. All endpoints enforce CloudAI's access control policies to ensure users can only access their own files (unless they have admin privileges).

## API Endpoints

### 1. List Files for User

**Endpoint**: `GET /api/files`

**Description**: Lists all task files for a specific user with access control.

**Query Parameters**:
- `requesting_user` (required): The ID of the user making the request
- `user_id` (required): The ID of the user whose files to list

**Response**: JSON array of task file information

**Example Request**:
```bash
curl "http://localhost:8080/api/files?requesting_user=alice&user_id=alice"
```

**Example Response**:
```json
{
  "user_id": "alice",
  "tasks": [
    {
      "task_id": "task-123",
      "task_name": "data-processing",
      "timestamp": "2025-11-17 14:30:00",
      "files": [
        "output.txt",
        "results.csv",
        "logs/app.log"
      ],
      "storage_path": "/home/user/.cloudai/files/alice/data-processing/2025-11-17_14-30-00/task-123"
    },
    {
      "task_id": "task-456",
      "task_name": "model-training",
      "timestamp": "2025-11-17 15:45:00",
      "files": [
        "model.pkl",
        "metrics.json"
      ],
      "storage_path": "/home/user/.cloudai/files/alice/model-training/2025-11-17_15-45-00/task-456"
    }
  ],
  "count": 2
}
```

**Status Codes**:
- `200 OK`: Successfully retrieved file list
- `400 Bad Request`: Missing required parameters
- `403 Forbidden`: Access denied (user cannot access another user's files)
- `503 Service Unavailable`: File storage not available

---

### 2. Get Task File Details

**Endpoint**: `GET /api/files/{task_id}`

**Description**: Retrieves detailed file information for a specific task.

**URL Parameters**:
- `task_id` (required): The ID of the task

**Query Parameters**:
- `requesting_user` (required): The ID of the user making the request
- `user_id` (required): The ID of the user who owns the task

**Example Request**:
```bash
curl "http://localhost:8080/api/files/task-123?requesting_user=alice&user_id=alice"
```

**Example Response**:
```json
{
  "task_id": "task-123",
  "task_name": "data-processing",
  "timestamp": "2025-11-17 14:30:00",
  "files": [
    "output.txt",
    "results.csv",
    "logs/app.log"
  ],
  "storage_path": "/home/user/.cloudai/files/alice/data-processing/2025-11-17_14-30-00/task-123"
}
```

**Status Codes**:
- `200 OK`: Successfully retrieved task files
- `400 Bad Request`: Missing required parameters or invalid URL format
- `403 Forbidden`: Access denied
- `404 Not Found`: Task not found
- `503 Service Unavailable`: File storage not available

---

### 3. Download File

**Endpoint**: `GET /api/files/{task_id}/download/{file_path}`

**Description**: Downloads a specific file from a task's output directory.

**URL Parameters**:
- `task_id` (required): The ID of the task
- `file_path` (required): Relative path to the file (can include subdirectories)

**Query Parameters**:
- `requesting_user` (required): The ID of the user making the request
- `user_id` (required): The ID of the user who owns the task

**Example Requests**:
```bash
# Download a file from task root
curl -O "http://localhost:8080/api/files/task-123/download/output.txt?requesting_user=alice&user_id=alice"

# Download a file from subdirectory
curl -O "http://localhost:8080/api/files/task-123/download/logs/app.log?requesting_user=alice&user_id=alice"
```

**Response**: Binary file data with appropriate headers

**Response Headers**:
- `Content-Disposition`: `attachment; filename="filename.ext"`
- `Content-Type`: `application/octet-stream`
- `Content-Length`: File size in bytes

**Status Codes**:
- `200 OK`: Successfully downloaded file
- `400 Bad Request`: Missing required parameters or invalid URL format
- `403 Forbidden`: Access denied (includes path traversal attempts)
- `404 Not Found`: File not found
- `503 Service Unavailable`: File storage not available

---

### 4. Delete Task Files

**Endpoint**: `DELETE /api/files/{task_id}`

**Description**: Deletes all files associated with a specific task.

**URL Parameters**:
- `task_id` (required): The ID of the task

**Query Parameters**:
- `requesting_user` (required): The ID of the user making the request
- `user_id` (required): The ID of the user who owns the task

**Example Request**:
```bash
curl -X DELETE "http://localhost:8080/api/files/task-123?requesting_user=alice&user_id=alice"
```

**Example Response**:
```json
{
  "status": "success",
  "message": "Deleted files for task task-123",
  "task_id": "task-123"
}
```

**Status Codes**:
- `200 OK`: Successfully deleted files
- `400 Bad Request`: Missing required parameters
- `403 Forbidden`: Access denied
- `404 Not Found`: Task not found
- `503 Service Unavailable`: File storage not available

---

## Access Control

All file API endpoints enforce CloudAI's access control policies:

### User Isolation
- **Users can only access their own files**
- Example: `alice` cannot access `bob`'s files
- Attempting to access another user's files returns `403 Forbidden`

### Admin Privileges
- **Admin users can access any files**
- Set user as admin in access control configuration
- Useful for debugging and system administration

### Path Traversal Protection
- **Blocked patterns**: `../`, absolute paths (`/etc/passwd`)
- Prevents directory traversal attacks
- Returns `403 Forbidden` for malicious paths

### Audit Logging
All file access attempts are logged with:
- Requesting user ID
- Target user ID
- File path
- Access result (allowed/denied)

---

## Usage Examples

### Scenario 1: User Lists Their Own Files
```bash
# Alice lists her files
curl "http://localhost:8080/api/files?requesting_user=alice&user_id=alice"
```
✅ **Result**: Success - Alice can access her own files

---

### Scenario 2: User Tries to Access Another User's Files
```bash
# Alice tries to list Bob's files
curl "http://localhost:8080/api/files?requesting_user=alice&user_id=bob"
```
❌ **Result**: `403 Forbidden` - Access denied

---

### Scenario 3: Admin Lists Any User's Files
```bash
# Admin lists Bob's files
curl "http://localhost:8080/api/files?requesting_user=admin&user_id=bob"
```
✅ **Result**: Success - Admin has access to all files

---

### Scenario 4: Download Multiple Files
```bash
# Get file list
FILES=$(curl -s "http://localhost:8080/api/files/task-123?requesting_user=alice&user_id=alice" | \
  jq -r '.files[]')

# Download each file
for file in $FILES; do
  curl -O "http://localhost:8080/api/files/task-123/download/$file?requesting_user=alice&user_id=alice"
done
```

---

### Scenario 5: Path Traversal Attack (Blocked)
```bash
# Attempt to access system file
curl "http://localhost:8080/api/files/task-123/download/../../../etc/passwd?requesting_user=alice&user_id=alice"
```
❌ **Result**: `403 Forbidden` - Path traversal blocked

---

## Integration with Task Workflow

### Complete Task-to-Download Flow

1. **Submit Task**
```bash
curl -X POST http://localhost:8080/api/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "docker_image": "alpine",
    "command": "echo Hello > /output/greeting.txt",
    "cpu_required": 1,
    "memory_required": 512,
    "user_id": "alice"
  }'
```
Response:
```json
{
  "task_id": "task-789",
  "status": "queued",
  "message": "Task submitted successfully"
}
```

2. **Wait for Task Completion**
```bash
# Check task status
curl "http://localhost:8080/api/tasks/task-789?user_id=alice"
```

3. **List Generated Files**
```bash
curl "http://localhost:8080/api/files/task-789?requesting_user=alice&user_id=alice"
```
Response:
```json
{
  "task_id": "task-789",
  "task_name": "alpine",
  "files": ["greeting.txt"],
  "timestamp": "2025-11-17 16:00:00"
}
```

4. **Download File**
```bash
curl -O "http://localhost:8080/api/files/task-789/download/greeting.txt?requesting_user=alice&user_id=alice"
```

5. **Cleanup (Optional)**
```bash
curl -X DELETE "http://localhost:8080/api/files/task-789?requesting_user=alice&user_id=alice"
```

---

## Error Handling

### Common Error Responses

#### Missing Parameters
```json
{
  "error": "Missing requesting_user parameter"
}
```
**Status**: `400 Bad Request`

#### Access Denied
```json
{
  "error": "access denied: user alice cannot access files owned by bob"
}
```
**Status**: `403 Forbidden`

#### File Not Found
```json
{
  "error": "task files not found for task task-999"
}
```
**Status**: `404 Not Found`

#### Service Unavailable
```json
{
  "error": "File storage not available"
}
```
**Status**: `503 Service Unavailable`

---

## Security Considerations

### 1. Authentication
**Current**: Query parameter-based user identification  
**Production**: Should use proper authentication tokens (JWT, OAuth2)

Example with JWT:
```bash
curl -H "Authorization: Bearer <token>" \
  "http://localhost:8080/api/files?user_id=alice"
```

### 2. Authorization
**Implemented**: CloudAI access control enforces user isolation  
**Layers**:
- Application-level: AccessControl checks
- File system: 0700/0600 permissions

### 3. Rate Limiting
**Recommendation**: Implement rate limiting for download endpoints
```go
// Example middleware
func rateLimitMiddleware(next http.Handler) http.Handler {
    limiter := rate.NewLimiter(10, 20) // 10 req/sec, burst 20
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        if !limiter.Allow() {
            http.Error(w, "Rate limit exceeded", http.StatusTooManyRequests)
            return
        }
        next.ServeHTTP(w, r)
    })
}
```

### 4. CORS
**Current**: Allows all origins (`Access-Control-Allow-Origin: *`)  
**Production**: Restrict to specific domains
```go
w.Header().Set("Access-Control-Allow-Origin", "https://your-domain.com")
```

---

## File Organization

Files are organized in a hierarchical structure:

```
~/.cloudai/files/
└── <user_id>/           # User isolation
    └── <task_name>/     # Task grouping
        └── <timestamp>/ # Time-based organization
            └── <task_id>/
                ├── output.txt
                ├── results.csv
                └── logs/
                    └── app.log
```

**Example**:
```
~/.cloudai/files/
├── alice/
│   ├── data-processing/
│   │   └── 2025-11-17_14-30-00/
│   │       └── task-123/
│   │           ├── output.txt
│   │           └── results.csv
│   └── model-training/
│       └── 2025-11-17_15-45-00/
│           └── task-456/
│               └── model.pkl
└── bob/
    └── web-scraper/
        └── 2025-11-17_16-00-00/
            └── task-789/
                └── data.json
```

---

## Implementation Details

### File Handler (`master/internal/http/file_handler.go`)

Key components:
```go
type FileAPIHandler struct {
    fileStorage *storage.FileStorageService
    quietMode   bool
}

// Methods:
- HandleListFiles()        // GET /api/files
- HandleGetTaskFiles()     // GET /api/files/{task_id}
- HandleDownloadFile()     // GET /api/files/{task_id}/download/{file_path}
- HandleDeleteTaskFiles()  // DELETE /api/files/{task_id}
```

### Access Control Integration
All handlers use `*WithAccess()` methods:
```go
// List files with access control
files, err := h.fileStorage.ListUserFilesWithAccess(requestingUserID, targetUserID)

// Get task files with access control
metadata, err := h.fileStorage.GetTaskFilesWithAccess(requestingUserID, targetUserID, taskID)

// Read file with access control
data, err := h.fileStorage.ReadFileWithAccess(requestingUserID, targetUserID, taskID, filePath)

// Delete files with access control
err := h.fileStorage.DeleteTaskFilesWithAccess(requestingUserID, targetUserID, taskID)
```

### Registration in Main
```go
// main.go
if fileStorage != nil {
    fileHandler := httpserver.NewFileAPIHandler(fileStorage)
    httpTelemetryServer.RegisterFileHandlers(fileHandler)
    log.Println("✓ File API handlers registered")
}
```

---

## Testing

### Manual Testing

1. **Start Master**
```bash
./runMaster.sh
```

2. **Submit Task with File Generation**
```bash
curl -X POST http://localhost:8080/api/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "docker_image": "alpine",
    "command": "echo test > /output/test.txt && ls -la /output",
    "cpu_required": 1,
    "memory_required": 512,
    "user_id": "testuser"
  }'
```

3. **List Files**
```bash
curl "http://localhost:8080/api/files?requesting_user=testuser&user_id=testuser"
```

4. **Download File**
```bash
curl -O "http://localhost:8080/api/files/<task-id>/download/test.txt?requesting_user=testuser&user_id=testuser"
```

5. **Verify Access Control**
```bash
# Try to access as different user (should fail)
curl "http://localhost:8080/api/files?requesting_user=otheruser&user_id=testuser"
```

---

## Related Documentation

- [File Transfer Implementation](./048_FILE_TRANSFER_IMPLEMENTATION.md)
- [Access Control Implementation](./051_ACCESS_CONTROL_IMPLEMENTATION.md)
- [File Organization](./050_FILE_ORGANIZATION.md)
- [HTTP API Reference](../HTTP_API_REFERENCE.md)

---

## Future Enhancements

### 1. Bulk Download
**Endpoint**: `GET /api/files/{task_id}/download-all`  
**Description**: Download all files as ZIP archive

### 2. File Streaming
**Endpoint**: `GET /api/files/{task_id}/stream/{file_path}`  
**Description**: Stream large files without loading into memory

### 3. File Search
**Endpoint**: `GET /api/files/search?query=<pattern>`  
**Description**: Search files by name or content

### 4. File Metadata
**Endpoint**: `GET /api/files/{task_id}/metadata`  
**Description**: Get file sizes, checksums, mime types

### 5. Presigned URLs
**Endpoint**: `POST /api/files/{task_id}/presign`  
**Description**: Generate time-limited download URLs

---

## Summary

✅ **File Retrieval API Implemented**
- List files for users with access control
- Get task file details
- Download individual files
- Delete task files
- Full integration with CloudAI access control

✅ **Security Features**
- User isolation enforced
- Path traversal protection
- Audit logging for all access
- Admin privileges supported

✅ **Production Ready**
- Built and tested successfully
- Comprehensive error handling
- CORS support for web clients
- RESTful API design

The File Retrieval API provides a complete solution for users to manage files generated by their tasks while maintaining CloudAI's security guarantees.
